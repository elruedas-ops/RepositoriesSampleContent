{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    },
    "analytic-id": {
      "type": "string",
      "defaultValue": "c62d2a2f-1820-4030-86cc-a6dd2cdb7559",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    }
  },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic-id'))]",
            "kind": "Scheduled",
            "apiVersion": "2020-01-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "COE-AO-PER-001-[WOS] Suspicious registry activity",
                "description": "[Detección ds intrusión-DS-T1012]\nAlerta que identifica las acciones frente al Registro de Windows y de esta manera tener recopilada la información sobre el sistema, la configuración y el software instalado, evitando así el comportamiento anómalo del adversario.",
                "severity": "Medium",
                "enabled": true,
                "query": "// The query_now parameter represents the time (in UTC) at which the scheduled analytics rule ran to produce this alert.\r\n// T1012 - Query Registry\r\n// Reference: https://attack.mitre.org/techniques/T1012/\r\nlet timeframe = 5m;\r\nSecurityEvent\r\n| where TimeGenerated >= ago(timeframe)\r\n| where SubjectDomainName !contains \"azwehcmxras0\"\r\n| where CommandLine startswith \"reg\" and (CommandLine contains \"add\" or CommandLine contains \"delete\" or CommandLine contains \"query\" or CommandLine contains \"load\" or CommandLine contains \"copy\" or CommandLine contains \"restore\")\r\n    and (CommandLine has \"Software\\\\Microsoft\\\\Terminal Server Client\\\\Default\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Uninstall\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Internet Settings\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\DRM\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Cryptography\\\\MachineGuid\"\r\n    or CommandLine has \"Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\"\r\n    or CommandLine has \"System\\\\CurrentControlSet\\\\Control\\\\Lsa Name\"\r\n    or CommandLine has \"System\\\\CurrentControlSet\\\\Services\\\\Tcpip\\\\Parameters\\\\Interfaces\"\r\n    or CommandLine has \"System\\\\CurrentControlSet\\\\Services\\\\mssmbios\\\\Data\\\\SMBiosData\"\r\n    or CommandLine has \"System\\\\CurrentControlSet\\\\Control\\\\Session Manager\")\r\n| order by TimeGenerated desc\r\n\r\n\r\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "Discovery"
                ],
                "techniques": [],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "P1D",
                        "matchingMethod": "Selected",
                        "groupByEntities": [
                            "Account"
                        ],
                        "groupByAlertDetails": [
                            "DisplayName"
                        ],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "CommandLine",
                                "columnName": "CommandLine"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "AccountDomain"
                            }
                        ]
                    },
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "AccountName"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}
